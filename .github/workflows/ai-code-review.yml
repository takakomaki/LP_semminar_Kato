name: AI Code Review (Copilot)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  
permissions:
  pull-requests: write
  contents: read

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }} HEAD)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze code with AI
        id: ai_review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python3 << 'PYTHON_EOF'
          import os
          import json
          import subprocess
          from pathlib import Path

          # PR diff ã‚’èª­ã¿è¾¼ã‚€
          diff = """${{ steps.diff.outputs.diff }}"""

          # ã‚·ãƒ³ãƒ—ãƒ«ãªé™çš„åˆ†æž
          review_points = []

          if "console.log" in diff:
              review_points.append({
                  "type": "warning",
                  "message": "âš ï¸ console.log ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚æœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚"
              })

          if "TODO" in diff or "FIXME" in diff:
              review_points.append({
                  "type": "info",
                  "message": "ðŸ“ TODO/FIXME ã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚"
              })

          if "any" in diff.lower():
              review_points.append({
                  "type": "warning",
                  "message": "âš ï¸ TypeScript ã® `any` åž‹ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚å¯èƒ½ãªé™ã‚Šé¿ã‘ã¦ãã ã•ã„ã€‚"
              })

          if "===" not in diff and "!==" not in diff and "==" in diff:
              review_points.append({
                  "type": "warning",
                  "message": "âš ï¸ ç·©ã„æ¯”è¼ƒ (==) ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚åŽ³å¯†ãªæ¯”è¼ƒ (===) ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚"
              })

          # å‡ºåŠ›
          with open('ai_review.json', 'w') as f:
              json.dump(review_points, f)

          for point in review_points:
              print(f"{point['type'].upper()}: {point['message']}")
          PYTHON_EOF

      - name: Format review as comment
        id: format_review
        run: |
          python3 << 'PYTHON_EOF'
          import json

          with open('ai_review.json', 'r') as f:
              review_points = json.load(f)

          comment = "## ðŸ¤– Copilot Code Review\n\n"

          if review_points:
              for point in review_points:
                  if point['type'] == 'error':
                      comment += f"ðŸ”´ **Error**: {point['message']}\n"
                  elif point['type'] == 'warning':
                      comment += f"ðŸŸ¡ **Warning**: {point['message']}\n"
                  else:
                      comment += f"â„¹ï¸ **Info**: {point['message']}\n"
          else:
              comment += "âœ… ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†ã€‚ç‰¹ã«æŒ‡æ‘˜äº‹é …ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\n"

          comment += "\n---\n"
          comment += "ðŸ’¡ **ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹:**\n"
          comment += "- TypeScript ã®åŽ³å¯†ãªåž‹ãƒã‚§ãƒƒã‚¯ã‚’æ´»ç”¨\n"
          comment += "- console.log ã§ã¯ãªã logger ã‚’ä½¿ç”¨\n"
          comment += "- === ã‚’ä½¿ç”¨ã—ã¦åŽ³å¯†ã«æ¯”è¼ƒ\n"

          with open('review_comment.md', 'w') as f:
              f.write(comment)

          print(comment)
          PYTHON_EOF

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('review_comment.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
